name: Lint & Detect Keywords

on:
  push:
  workflow_dispatch:
  pull_request:
  
jobs:
  super-lint:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ðŸ“„ List all checked out files
        run: find . -type f

      - name: ðŸ§¹ Run Super-Linter
        uses: super-linter/super-linter@v7.1.0
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_JSON: true
          VALIDATE_PYTHON: true
          VALIDATE_JAVASCRIPT_STANDARD: true
          
      - name: ðŸ“ Add Super-Linter Markdown Summary
        if: always()
        run: |
          echo "### Code Style Check Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "This workflow checks code formatting for:" >> "$GITHUB_STEP_SUMMARY"
          echo "- Python" >> "$GITHUB_STEP_SUMMARY"
          echo "- JavaScript" >> "$GITHUB_STEP_SUMMARY"
          echo "- JSON" >> "$GITHUB_STEP_SUMMARY"

      - name: ðŸ“¦ Upload Super-Linter Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: super-linter-output
          path: super-linter-output/

  detect-keywords:
    name: Detect `console.log` or `print`
    runs-on: ubuntu-latest      

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ•µï¸â€â™€ï¸ Scan for Debug Keywords
        run: |
          echo "ðŸ” Scanning repo for console.log and print statements..."

          # Collect all .js and .py files
          FILE_PATHS=$(find . -type f \( -name "*.js" -o -name "*.py" \))

          # Flags to track findings
          hit_flag=0
          js_flag=0
          py_flag=0

          # Output folder and report file
          mkdir -p keyword-scan-output
          REPORT_FILE=keyword-scan-output/keyword-scan-report.md

          echo "## ðŸ”Ž Keyword Scan Report" > "$REPORT_FILE"

          format_path() {
            clean_path="${1#./}"
            if [[ "$clean_path" == */* ]]; then
              echo "ðŸ—‚ï¸ _${clean_path}_"
            else
              echo "ðŸ“„ _${clean_path}_"
            fi
          }

          # Loop through files
          while IFS= read -r path; do
            if [[ -f "$path" ]]; then
              if [[ "$path" == *.js ]]; then
                results=$(grep -Hn "console\.log" "$path" || true)
                if [[ -n "$results" ]]; then
                  if [[ "$js_flag" -eq 0 ]]; then
                    echo "**console.log found in:**" >> "$REPORT_FILE"
                    js_flag=1
                  fi
                  format_path "$path" >> "$REPORT_FILE"
                  echo '```js' >> "$REPORT_FILE"
                  echo "$results" | sed -E "s|$path:||" >> "$REPORT_FILE"
                  echo '```' >> "$REPORT_FILE"
                  hit_flag=1
                fi
              elif [[ "$path" == *.py ]]; then
                results=$(grep -Hn "print" "$path" || true)
                if [[ -n "$results" ]]; then
                  if [[ "$py_flag" -eq 0 ]]; then
                    echo -e "\n**print found in:**" >> "$REPORT_FILE"
                    py_flag=1
                  fi
                  format_path "$path" >> "$REPORT_FILE"
                  echo '```py' >> "$REPORT_FILE"
                  echo "$results" | sed -E "s|$path:||" >> "$REPORT_FILE"
                  echo '```' >> "$REPORT_FILE"
                  hit_flag=1
                fi
              fi
            fi
          done <<< "$FILE_PATHS"

          # Final summary
          if [[ "$hit_flag" -eq 1 ]]; then
            echo "âŒ Detected disallowed keywords."
            cat "$REPORT_FILE" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          else
            echo "âœ… No disallowed keywords found."
            echo -e "\nâœ… No disallowed keywords found." | tee -a "$REPORT_FILE" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: ðŸ“¦ Upload keyword scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: keyword-scan-report
          path: keyword-scan-output/
